<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR Law Updates • NYC / NYS</title>
  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b0c10; color:#eef1f7 }
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .sub{color:#9aa3b2;font-size:13px;margin-top:4px}
    input,button{height:40px;border-radius:8px;border:1px solid #232635;background:#151821;color:#eef1f7;padding:0 10px}
    .row{display:flex;gap:8px;margin:10px 0}
    .item{background:#151821;border:1px solid #232635;border-radius:12px;padding:12px;margin-top:10px}
    .meta{color:#9aa3b2;font-size:12px}
    .star{cursor:pointer;float:right}
    .quick a{display:inline-block;margin-right:8px;margin-bottom:8px;padding:8px 10px;border:1px solid #232635;border-radius:8px;background:#10141c;color:#eef1f7;text-decoration:none;font-size:13px}
    .err{color:#fca5a5}
    .ok{color:#86efac}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>NYC / NYS Employment Law Updates</h1>
    <p id="diag" class="sub">Status: using built-in examples while checking for updates…</p>

    <!-- Quick links -->
    <p class="quick">
      <a href="https://rules.cityofnewyork.us/" target="_blank" rel="noopener">NYC Rules</a>
      <a href="https://council.nyc.gov/legislation/" target="_blank" rel="noopener">NYC Council</a>
      <a href="https://a856-cityrecord.nyc.gov/" target="_blank" rel="noopener">City Record</a>
      <a href="https://dos.ny.gov/state-register" target="_blank" rel="noopener">NYS Register</a>
      <a href="https://dol.ny.gov/" target="_blank" rel="noopener">NYS DOL</a>
    </p>

    <div class="row">
      <input id="q" type="search" placeholder="Search: wage, sick leave, PFL, retaliation, salary transparency…" />
      <button id="clear">Clear</button>
      <a id="openjson" class="quick" href="#" target="_blank" rel="noopener" style="margin-left:auto;">Open updates.json</a>
    </div>

    <p id="count" class="meta">0 items</p>
    <div id="list"></div>
  </div>

  <script>
    // ---- Bookmarks ----
    const LS_KEY = 'hrlaw.bookmarks.v1';
    function getBookmarks(){ try{ return new Set(JSON.parse(localStorage.getItem(LS_KEY)||'[]')); }catch{return new Set();}}
    function setBookmarks(set){ localStorage.setItem(LS_KEY,JSON.stringify(Array.from(set))); }

    // ---- Example fallback (renders immediately) ----
    let SEED = [
      {id:'ex1',source:'NYC Council',title:'(Example) Amend Safe and Sick Time Act',date:'2025-09-20',url:'https://council.nyc.gov/legislation/',tags:['NYC','Leave']},
      {id:'ex2',source:'NYC Rules',title:'(Example) Proposed payroll record rule',date:'2025-09-18',url:'https://rules.cityofnewyork.us/',tags:['NYC','Records']}
    ];

    // ---- DOM ----
    const $list=document.getElementById('list');
    const $count=document.getElementById('count');
    const $q=document.getElementById('q');
    const $clear=document.getElementById('clear');
    const $diag=document.getElementById('diag');
    const $openjson=document.getElementById('openjson');

    // Build absolute path for GitHub Pages project sites
    const PROJECT_PATH = '/hr-law-updates'; // <<< your repo name
    const ABS_URL = PROJECT_PATH + '/updates.json';
    const REL_URL = './updates.json';

    // Helper: render
    function render(){
      const q=($q.value||'').toLowerCase();
      const bookmarks=getBookmarks();
      let data=SEED.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
      if(q) data=data.filter(x=>{
        const hay=[x.title,(x.tags||[]).join(' '),x.source].join(' ').toLowerCase();
        return hay.includes(q);
      });
      $count.textContent=`${data.length} item${data.length===1?'':'s'} shown`;
      $list.innerHTML=data.map(x=>{
        const on=bookmarks.has(x.id);
        return `<div class="item">
          <div><strong>${x.title}</strong><span class="star" data-id="${x.id}">${on?'★':'☆'}</span></div>
          <div class="meta">${x.source} · ${x.date}</div>
          <a href="${x.url}" target="_blank" rel="noopener">Open official page</a>
        </div>`;
      }).join('');
      $list.querySelectorAll('.star').forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute('data-id');const set=getBookmarks();
          if(set.has(id))set.delete(id);else set.add(id);
          setBookmarks(set);render();
        };
      });
    }

    // Initial paint
    render();

    // ---- Safe fetch with dual paths + timeout ----
    async function fetchWithTimeout(url, ms=12000){
      const ctrl = new AbortController();
      const tout = setTimeout(()=>ctrl.abort(), ms);
      try {
        const r = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
        if (!r.ok) return { ok:false, status:r.status, data:null };
        const data = await r.json().catch(()=>null);
        return { ok:true, status:r.status, data };
      } catch (e) {
        return { ok:false, status:'ERR', data:null, err:e && e.name || 'error' };
      } finally { clearTimeout(tout); }
    }

    async function tryLoad(){
      $diag.textContent = 'Status: checking for updates.json (absolute path)…';
      $openjson.href = ABS_URL;
      let res = await fetchWithTimeout(ABS_URL + '?bust=' + Date.now());
      if (res.ok && Array.isArray(res.data)) {
        SEED = res.data;
        $diag.innerHTML = `<span class="ok">Loaded ${SEED.length} items from ${ABS_URL}</span>`;
        render();
        return;
      }
      // Try relative
      $diag.textContent = 'Status: checking for updates.json (relative path)…';
      $openjson.href = REL_URL;
      res = await fetchWithTimeout(REL_URL + '?bust=' + Date.now());
      if (res.ok && Array.isArray(res.data)) {
        SEED = res.data;
        $diag.innerHTML = `<span class="ok">Loaded ${SEED.length} items from ${REL_URL}</span>`;
        render();
        return;
      }
      // Show reason
      $diag.innerHTML = `<span class="err">Could not load updates.json (tried ${ABS_URL} and ${REL_URL}).</span>`;
    }

    tryLoad();

    // Search events
    $q.addEventListener('input', render);
    $clear.addEventListener('click', ()=>{ $q.value=''; render(); });
  </script>
</body>
</html>
